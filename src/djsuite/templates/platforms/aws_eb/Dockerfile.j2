# Stage 1: Build stage
FROM python:{{ python_version }}-slim AS builder

# Set environment variables to prevent .pyc files and enable immediate output.
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# Install system dependencies needed to build Python packages
RUN apt-get update && apt-get install -y \
    build-essential \
    libpq-dev \
    git \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Upgrade pip and install PDM
RUN pip install --upgrade pip setuptools wheel
RUN pip install "pdm==2.26.1"

# Set working directory
WORKDIR /app

ARG PDM_GROUPS="--prod"

# Copy pyproject.toml and pdm.lock to install dependencies
ADD pyproject.toml pdm.lock* /app/

# Install dependencies using PDM (production dependencies only)
RUN pdm install ${PDM_GROUPS} --no-editable -v

# Stage 2: Production stage
FROM python:{{ python_version }}-slim

# Set environment variables to prevent .pyc files and enable immediate output
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

## Install packages
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
    supervisor \
    nano \
    nginx \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user
RUN groupadd -r appuser && useradd -r -g appuser -d /app -s /sbin/nologin appuser

# Copy Python dependencies and PDM from the builder stage
COPY --from=builder /root/.local /root/.local
COPY --from=builder /usr/local/bin /usr/local/bin
COPY --from=builder /usr/local/lib /usr/local/lib

## Copy nginx settings
COPY ./nginx/default.conf /etc/nginx/conf.d/default.conf

## Remove old settings and put std logs to nginx logs
RUN rm /etc/nginx/sites-enabled/default \
    && ln -sf /dev/stdout /var/log/nginx/access.log \
    && ln -sf /dev/stderr /var/log/nginx/error.log

ADD . /app/

COPY --from=builder /app /app/

COPY ./supervisord_app.conf    /app/supervisord_app.conf
# add worker + beat configs
COPY ./supervisord_worker_beat.conf /app/supervisord_worker_beat.conf

# Set working directory
WORKDIR /app

EXPOSE 80

COPY ./entrypoint.sh /app/entrypoint.sh
COPY ./release.sh    /app/release.sh

RUN chmod +x /app/entrypoint.sh /app/release.sh

# Give appuser ownership of the app directory and nginx/supervisor dirs it needs
RUN chown -R appuser:appuser /app \
    && chown -R appuser:appuser /var/log/nginx \
    && chown -R appuser:appuser /var/lib/nginx \
    && chown -R appuser:appuser /run

USER appuser
ENTRYPOINT ["/app/entrypoint.sh"]
