name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  id-token: write
  pull-requests: write

jobs:
  guard:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_run=true" >> "$GITHUB_OUTPUT"
          elif [[ "${{ github.event.head_commit.message }}" != *"[skip ci]"* ]]; then
            echo "should_run=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_run=false" >> "$GITHUB_OUTPUT"
            echo "Skipping: commit message contains [skip ci]"
          fi

  compute-version:
    needs: [guard]
    if: needs.guard.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.version.outputs.tag }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute next semver from PR labels
        id: version
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LATEST=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          MAJOR=$(echo "$LATEST" | sed 's/^v//' | cut -d. -f1)
          MINOR=$(echo "$LATEST" | sed 's/^v//' | cut -d. -f2)
          PATCH=$(echo "$LATEST" | sed 's/^v//' | cut -d. -f3)

          # Get labels from PRs merged since last tag
          SINCE=$(git log -1 --format=%aI "$LATEST" 2>/dev/null || echo "2000-01-01")
          LABELS=$(gh pr list --state merged --base main \
            --json mergedAt,labels \
            --jq "[.[] | select(.mergedAt >= \"$SINCE\") | .labels[].name] | unique | .[]" 2>/dev/null || echo "")

          BUMP="patch"
          if echo "$LABELS" | grep -q "breaking"; then
            BUMP="major"
          elif echo "$LABELS" | grep -q "feature"; then
            BUMP="minor"
          fi

          case "$BUMP" in
            major) NEXT="v$((MAJOR + 1)).0.0" ;;
            minor) NEXT="v${MAJOR}.$((MINOR + 1)).0" ;;
            patch) NEXT="v${MAJOR}.${MINOR}.$((PATCH + 1))" ;;
          esac

          echo "tag=${NEXT}" >> "$GITHUB_OUTPUT"
          echo "version=${NEXT#v}" >> "$GITHUB_OUTPUT"
          echo "Bump: ${BUMP} | ${LATEST} -> ${NEXT}"

  test:
    needs: [guard]
    if: needs.guard.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install PDM
        run: pip install pdm

      - name: Install djsuite with dev deps
        run: pip install -e ".[dev]"

      - name: Run tests with coverage
        run: pytest -v

  publish:
    needs: [compute-version, test]
    runs-on: ubuntu-latest
    environment: pypi
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Update version from tag
        run: |
          VERSION="${{ needs.compute-version.outputs.version }}"
          sed -i "s/^version = \".*\"/version = \"${VERSION}\"/" pyproject.toml
          sed -i "s/^__version__ = \".*\"/__version__ = \"${VERSION}\"/" src/djsuite/__init__.py

      - name: Build package
        run: |
          pip install build
          python -m build

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

  github-release:
    needs: [compute-version, test, publish]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create tag
        run: |
          TAG="${{ needs.compute-version.outputs.tag }}"
          git tag "$TAG"
          git push origin "$TAG"

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ needs.compute-version.outputs.tag }}" \
            --generate-notes \
            --title "${{ needs.compute-version.outputs.tag }}"

      - name: Update version files and CHANGELOG via PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.compute-version.outputs.tag }}"
          VERSION="${{ needs.compute-version.outputs.version }}"
          DATE=$(date +%Y-%m-%d)
          BRANCH="release/${TAG}"

          # Update version in source
          sed -i "s/^version = \".*\"/version = \"${VERSION}\"/" pyproject.toml
          sed -i "s/^__version__ = \".*\"/__version__ = \"${VERSION}\"/" src/djsuite/__init__.py

          # Update CHANGELOG.md
          BODY=$(gh release view "$TAG" --json body --jq '.body')
          ENTRY=$(printf "## %s (%s)\n\n%s\n" "$TAG" "$DATE" "$BODY")

          if [ -f CHANGELOG.md ]; then
            HEAD=$(head -1 CHANGELOG.md)
            TAIL=$(tail -n +2 CHANGELOG.md)
            printf "%s\n\n%s\n%s\n" "$HEAD" "$ENTRY" "$TAIL" > CHANGELOG.md
          else
            printf "# Changelog\n\n%s\n" "$ENTRY" > CHANGELOG.md
          fi

          # Create branch and PR
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          git add pyproject.toml src/djsuite/__init__.py CHANGELOG.md
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "release: ${TAG} [skip ci]"
          git push origin "$BRANCH"
          gh pr create \
            --title "release: ${TAG}" \
            --body "Automated version bump and changelog update for ${TAG}." \
            --base main \
            --head "$BRANCH"
